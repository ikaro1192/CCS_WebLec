# データの永続化とSQL

## データの永続化について
さて、今までのプログラムでは
データを保存することができなかった。
しかし、実際にはユーザ登録をしたらその情報をどこかに保存する必要がある。
いくつかの方法が考えられるが、
最近のWebアプリケーションでもっともよく使われる方法がデータベースを使う方法だ。

### Webアプリケーションの特性とファイルによる管理の問題
データベースを使わずに単なるテキストファイルを使えばいいではないか
というふうに思うかもしれない。
しかし、データベースを使うと様々なメリットが存在する。
まずはそれらについて説明しよう。

#### トランザクション

トランザクションは平たくいってしまえば、
データの整合性を保つという目的のために存在する。
そのためにデータの復旧と同時実行制御をうまくできるようにしている。

トランザクションのメリットを理解するためにいくつか、
トランザクションがダメな例をあげよう。

まず、トランザクションがうまくいっていないわかりやすい例としては、
ゲームボーイ時代の(今も?)ポケモンの交換途中にケーブルを抜くと
両者にポケモンが残ってしまうというものだ。

次に銀行システムをつくることを考えよう。
この糞システムではトランザクションが実装されていない。
それを知ってか知らずかAさんはこのシステムを用いて預金を引き出そうとした。
プログラム上ではまず「口座残高から残金を減らす」という処理が走る。
この時点で不幸なことに停電があった。
復旧停電後、Aさんの手元には預金が減っているという事実だけがのこった...
これが復旧の問題だ。
これは、「残高を減らしてお金を出す」という処理をひとつのまとまりにし、
成功したら変更を書き込み、失敗したら変更前の状態に戻すという処理をすれば、
Aさんから文句は出ないだろう。

もうひとつ、同時実行制御だが、
例えばこれはAさんからBさんに3000円を送金し、Bさんは今預金が1万円あるところから2000円引き下ろそうというところだという
状況を想定する。

1. Aさんが送金実施
2. Bさんが引き下ろす。(この時点で8000にするという処理の予約がなされる)
3. Aさんから送金データが届く
4. 13000になる
5. 引き下ろす処理ができていなかったので実行。8000に

とAさんから振り込まれたデータが消えてしまった。
このような衝突は決して多いとは言えないが、それでも起こりえる事象である。
これも、それ以上わけられない単位にわけて、それが実行するまで
他の処理を走らせないようにするという処理する

#### 検索効率
テキストの検索は基本的に全文検索である。
これはデータ量に比例して計算量が増える。

## リレーショナルデータベース
まずはリレーショナルデータベースの概要について説明する。


### sqlite3
本講座ではデータベースとして比較的簡易で扱いやすい(=設定もサーバもいらない)
sqlite3を使う。

### sqlite3クライアントのダウンロード

```
.exit
```

で終了できる。

### SQL入門
多くのデータベースはSQLという言語を用いて、
データの操作をする。
多分にもれずsqlite3もSQLで操作ができる。

たとえばまずは本の在庫管理システムを考え
そのデータベースを作ってみよう。

#### create table
テーブルがなくては話にならない。
まずはID,書籍名,値段の情報を管理するテーブルを作ろう。
テーブルを作る文がcreate tableだ。
使い方は

```
create table Books(id INTEGER PRIMARY KEY AUTOINCREMENT,name TEXT NOT NULL, price INTEGER NOT NULL);
```

のようにする。
つまり一般的に

```
create table テーブル名(カラム名 型 付加情報, ...)
```

というようになる。
したがって今回は「INTEGER型でプライマリキー(次回説明,必須)かつオートインクリメントであるidという名前のカラム,
TEXT型でNULLではないname,
INTEGER型でNULLではないpriceという3つのカラムを持つBooksというテーブル」
を作成した。


次回詳細を説明するが、
最初のカラムは特に理由がない限り「id INTEGER PRIMARY KEY AUTOINCREMENT」とするのがよい。
念の為説明しておくとオートインクリメントというのは挿入したタイミングで自動的に
最後に挿入した値からインクリメントした値を割り当てられてくれるというものだ。

ちなみにsqlite3で存在する型は下記のとおりである。

* TEXT
* INTEGER
* REAL
* NONE

なお、正確には静的な型ではなく、型親和性というものなので注意しよう。

#### insert
次にデータをテーブルに挿入してみよう。
insert文を使ってできる。
たとえば

```
insert into Books(name,price) values("ModernC++Design",3990);
insert into Books(name,price) values("Hoge books",4990);
insert into Books(name,price) values("foo books",2590);
```

だ。一般化すれば

```
insert into 対象テーブル(値を入れるcolum,...) values(値,...);
```

となる。
また、先ほど説明したようにAUTOINCREMENTの項目は指定しなくても
自動的に値が入る。

#### select
検索をかけるのはselect文だ。
まずは特に条件を指定せずすべてのrowを表示してみよう。

```
select * from Books;
```

そうすると追加したものすべてが表示されたはずだ。
次にidが2のものの名前と価格を抽出してみよう。

```
select name,price from Books where id==2;
```

また、価格が3000円以上のものを抽出するには

```
select * from Books where price > 3000;
```

このように一般的には

```
select 抽出するcolum,... from 対象テーブル where 条件式;
```

となる。また抽出するcolumは「 * 」を指定すれば、すべてのcolumを選択したことになる。

使える条件式として使えるものは下記がある。

* ==
* !=
* >
* =>
* <
* =<

### Pythonからsqlite3を使う
SQLに慣れてきたところでPythonからSQLを発行してみよう。
標準でsqlite3モジュールが存在するので簡単に扱うことができる。

操作するときに重要になる概念がコネクションとカーソルである。
コネクションは名前の通りデータベースへの接続を管理する。
また、トランザクションを制御するのもコネクションオブジェクトである。
また、SQLを構築したり

副作用のある操作(DML,つまりinsert,update,delete,replace)を実行する際は
自動的にトランザクションが開始されコネクションを使って明示的にコミットするか、
副作用のないクエリを発行するまではコミットされない。

それを踏まえて以下のコードを見てみよう。




##問題

- 次のようなユーザとパスワードの組をDBに保存せよ
- 上記で作ったデータベースを使い認証ページを実装せよ。
